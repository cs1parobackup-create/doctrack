<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Tracker (YYYY-SSSSS)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f7f7f7; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 5px; }
        
        /* Header for Office Name and Controls */
        .app-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 2px solid #007bff; 
            margin-bottom: 20px; 
            font-size: 1.1em;
        }
        .app-header p { margin: 0; font-weight: bold; color: #333; }
        .app-header span { color: #dc3545; }
        .logout-btn { background-color: #6c757d; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background-color: #5a6268; }

        /* Login Screen Styling */
        #login-container {
            display: none; 
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #e6f0ff;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        .login-box h2 { color: #007bff; margin-top: 0; }
        .login-box select, .login-box input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .login-box button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            margin-top: 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover { background-color: #218838; }

        /* Form Container (3 columns) */
        .form-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px; background-color: #e6f0ff; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #0056b3; }
        .form-container input, .form-container select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Action Panel */
        .action-panel { display: flex; flex-direction: column; gap: 20px; padding: 20px; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 30px; background-color: #fff8e1; }
        .action-controls { display: flex; align-items: flex-end; gap: 15px; }
        .action-controls .input-group { flex-grow: 1; }
        .action-controls input { width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 4px; font-size: 16px; font-weight: bold; }
        
        .action-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .accept-btn { background-color: #28a745; color: white; }
        .release-btn { background-color: #dc3545; color: white; }
        .accept-btn:hover { background-color: #218838; }
        .release-btn:hover { background-color: #c82333; }

        /* Table and Persistence Controls */
        #documentTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #documentTable th, #documentTable td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 14px; }
        #documentTable th { background-color: #007bff; color: white; }
        #documentTable tr:nth-child(even) { background-color: #f2f2f2; }

        /* Barcode Cell Styling */
        .barcode-cell { text-align: center; }
        .barcode-cell svg { max-width: 150px; height: 50px; } 
        .barcode-cell .simple-id { 
            display: block; 
            font-weight: bold; 
            font-size: 14px; 
            margin-top: -5px; 
            color: #007bff;
        }
        
        .persistence-controls { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e6f0ff;
            border-radius: 8px;
        }

        .persistence-controls button {
            padding: 8px 15px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #saveDataBtn { background-color: #ffc107; color: #333; }
        #saveDataBtn:hover { background-color: #e0a800; }
        #clearDataBtn { background-color: #6c757d; color: white; }
        #clearDataBtn:hover { background-color: #5a6268; }
        
        /* Logged By column width */
        #documentTable th:last-child { width: 100px; } 
    </style>
</head>
<body>

<div id="login-container">
    <div class="login-box">
        <h2>Document Tracker Access</h2>
        <p>Please enter your name and select your office to begin.</p>
        
        <input type="text" id="nameInput" placeholder="Enter Your Name (e.g., J. Dela Cruz)" required>
        
        <select id="officeSelect" required>
            <option value="" disabled selected>Select Office</option>
            <option value="PARPO">PARPO</option>
            <option value="STOD">STOD</option>
            <option value="LEGAL">LEGAL</option>
            <option value="LTSP">LTSP</option>
            <option value="RECORDS">RECORDS</option>
            <option value="ARBDSP">ARBDSP</option>
            <option value="All Offices">All Offices (Admin View)</option> </select>
        
        <button onclick="attemptLogin()">Log In</button>
        <p style="font-size: 10px; color: #dc3545; margin-top: 20px;">
            ‚ö†Ô∏è This is for internal logging only.
        </p>
    </div>
</div>

<div id="app-container" style="display:none;">
    <div class="container">
        
        <div class="app-header">
            <h1 style="margin: 0;">Automated Document Tracker üìÑ (ID Format: YYYY-SSSSS)</h1>
            <p>
                User: <span id="loggedInUserDisplay">N/A</span> | Office: <span id="loggedInOfficeDisplay" style="color: #007bff;">N/A</span>
                <button class="logout-btn" onclick="logout()">Log Out</button>
            </p>
        </div>

        <div class="action-panel">
            <h2>Document Action: Auto-Generation and Status Update</h2>

            <div class="action-controls">
                <div class="input-group">
                    <label for="docId">Enter Full Tracking ID to Update/Release (e.g., YYYY-SSSSS):</label>
                    <input type="text" id="docId" placeholder="e.g., 2026-00001">
                </div>
                
                <div class="action-buttons">
                    <button class="accept-btn" onclick="handleAction('NEW_DOC')">Create NEW Unique Document ID</button>
                    <button class="release-btn" onclick="handleAction('RELEASE')">Release Document (Status Update)</button>
                </div>
            </div>
        </div>

        <div id="documentForm" class="form-container">
            <h2>New Document Details (Required for **NEW** Log Action)</h2>
            <div class="form-group">
                <label for="docType">Document Type:</label>
                <select id="docType" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Memorandum">Memorandum</option>
                    <option value="Request">Request</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Letter">Letter</option>
                    <option value="PSO">PSO</option>
                    <option value="Certificate">Certificate</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sourceOffice">Source Office:</label>
                <select id="sourceOffice" required>
                    <option value="" disabled selected>Select Source</option>
                    <option value="Legal Division">Legal Division</option>
                    <option value="Planning Section">Planning Section</option>
                    <option value="Finance Unit">Finance Unit</option>
                    <option value="Regional Office V">Regional Office V</option>
                    <option value="Central Office">Central Office</option>
                </select>
            </div>

            <div class="form-group">
                <label for="docDetails">Brief Subject/Details:</label>
                <input type="text" id="docDetails" required>
            </div>

            <div class="form-group">
                <label for="forwarderOffice">Forwarder Office (Initial Destination for New Log):</label> 
                <select id="forwarderOffice" required>
                    <option value="" disabled selected>Select Destination</option>
                    <option value="Legal Division">Legal Division</option>
                    <option value="Planning Section">Planning Section</option>
                    <option value="Finance Unit">Finance Unit</option>
                    <option value="Regional Office V">Regional Office V</option>
                    <option value="Records Section">Records Section</option>
                </select>
            </div>

            <div class="form-group">
                <label>Date Received (Auto-filled):</label>
                <input type="text" disabled placeholder="Will be set upon Acceptance">
            </div>
            
            <div class="form-group">
                <label>Date Released (Auto-filled on 'Release'):</label>
                <input type="text" disabled placeholder="N/A">
            </div>
        </div>

        <h2 id="tableHeader">Document Log (Showing Files for Your Office)</h2>
        
        <div class="persistence-controls">
            <button id="saveDataBtn" onclick="manualSaveDocuments()">Manually Save Log üíæ</button>
            <button id="clearDataBtn" onclick="clearDocuments()">Clear All Log Data ‚ö†Ô∏è</button>
        </div>

        <table id="documentTable">
            <thead>
                <tr>
                    <th>Tracking ID (YYYY-SSSSS)</th>
                    <th>Barcode</th>
                    <th>Type</th>
                    <th>Source Office</th>
                    <th>Date Received</th>
                    <th>Last Destination / Current Office</th>
                    <th>Date Released</th>
                    <th>Status</th>
                    <th>Logged By</th> 
                </tr>
            </thead>
            <tbody id="documentList">
                </tbody>
        </table>
    </div>
</div>

<script>
    // --- Data Storage Keys ---
    const COUNTER_KEY = 'docTrackerSequenceAnnual'; // Key now checks annual reset
    const DOCUMENTS_KEY = 'docTrackerDocuments'; 
    let documents = []; 

    // --- Login/Session Functions (UPDATED) ---
    function checkLogin() {
        // Retrieve both name and office from session storage
        const loggedInName = sessionStorage.getItem('docTrackerName');
        const loggedInOffice = sessionStorage.getItem('docTrackerOffice');

        if (loggedInName && loggedInOffice) {
            document.getElementById('loggedInUserDisplay').textContent = loggedInName;
            document.getElementById('loggedInOfficeDisplay').textContent = loggedInOffice;
            
            // Set the dynamic table header
            const headerText = (loggedInOffice === 'All Offices') 
                ? "Document Log (Showing ALL Files - Admin View)" 
                : `Document Log (Showing Files for ${loggedInOffice})`;
            document.getElementById('tableHeader').textContent = headerText;
            
            showApp();
        } else {
            showLogin();
        }
    }
    
    function showApp() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
    }
    
    function showLogin() {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
    
    function attemptLogin() {
        const name = document.getElementById('nameInput').value.trim();
        const office = document.getElementById('officeSelect').value; 

        if (name && office) {
            sessionStorage.setItem('docTrackerName', name); 
            sessionStorage.setItem('docTrackerOffice', office); 
            
            // Re-run checkLogin to update displays and filters
            checkLogin();
        } else {
            alert("Please enter your name and select your office.");
        }
    }
    
    function logout() {
        if (confirm("Are you sure you want to log out?")) {
            sessionStorage.removeItem('docTrackerName');
            sessionStorage.removeItem('docTrackerOffice');
            showLogin();
        }
    }
    
    function getCurrentUser() {
        return sessionStorage.getItem('docTrackerName') || 'UNKNOWN';
    }
    
    function getCurrentOffice() {
        return sessionStorage.getItem('docTrackerOffice') || 'UNKNOWN';
    }

    // --- Persistence Functions (Unchanged) ---
    function loadDocuments() {
        try {
            const storedDocs = localStorage.getItem(DOCUMENTS_KEY);
            if (storedDocs) {
                const parsedDocs = JSON.parse(storedDocs);
                if (Array.isArray(parsedDocs)) {
                    documents = parsedDocs;
                }
            }
        } catch (e) { console.error("Error loading documents from Local Storage:", e); }
    }
    function saveDocuments() {
        try {
            localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
        } catch (e) { console.error("Error saving documents to Local Storage:", e); }
    }
    function manualSaveDocuments() {
         try {
            localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
            alert("Log data successfully saved to browser's local storage.");
        } catch (e) {
            console.error("Error saving documents to Local Storage:", e);
            alert("Error: Could not save log data to Local Storage.");
        }
    }
    function clearDocuments() {
        if (confirm("WARNING: This will permanently DELETE ALL logged documents and reset the tracking ID counter. Are you sure?")) {
            localStorage.removeItem(DOCUMENTS_KEY);
            localStorage.removeItem(COUNTER_KEY);
            documents = []; 
            displayDocuments();
            alert("All log data has been cleared.");
        }
    }

    // --- Tracking ID Generation Logic (UPDATED for YYYY-SSSSS) ---

    function getCurrentYear() {
        return new Date().getFullYear().toString(); // YYYY
    }

    function getSequence() {
        const currentYear = getCurrentYear(); 
        let sequenceData = JSON.parse(localStorage.getItem(COUNTER_KEY));
        
        if (!sequenceData || sequenceData.year !== currentYear) {
            // Reset counter if storage is empty or year has changed (Annual Reset)
            sequenceData = { year: currentYear, sequence: 0 };
        }

        sequenceData.sequence++;
        localStorage.setItem(COUNTER_KEY, JSON.stringify(sequenceData));
        // Pad sequence to 5 digits (SSSSS)
        return String(sequenceData.sequence).padStart(5, '0');
    }

    function generateTrackingID() {
        const currentYear = getCurrentYear(); // YYYY
        const sequencePart = getSequence(); // SSSSS

        // Format: YYYY-SSSSS
        return `${currentYear}-${sequencePart}`;
    }
    
    // --- Barcode Functions (Updated to use YYYY-SSSSS split) ---

    function generateBarcodeSVG(id) {
        // Find the sequence part (SSSSS)
        const parts = id.split('-');
        let simpleId = 'N/A';
        
        // If the ID is valid (e.g., 2026-00001)
        if (parts.length === 2) {
            const sequence5Digit = parts[1]; // e.g., "00001"
            // Get the last 4 digits
            simpleId = sequence5Digit.slice(-4); // e.g., "0001"
        }
        
        // Encodes the FULL ID (YYYY-SSSSS) but displays the simple 4-digit sequence
        return `<svg id="barcode-${id}"></svg><span class="simple-id">${simpleId}</span>`;
    }

    function renderBarcode(id) {
        if (document.getElementById(`barcode-${id}`)) {
            try {
                // IMPORTANT: Encoding the FULL unique ID is crucial for correct lookup
                JsBarcode(`#barcode-${id}`, id, {
                    format: "CODE128", 
                    displayValue: false, // Do NOT display the text inside the barcode image
                    width: 1.5, 
                    height: 50
                });
            } catch (e) {
                console.error("Error rendering barcode:", e);
            }
        }
    }

    // --- Document Logging (Unchanged) ---

    function getCurrentDateOnly() {
        return new Date().toISOString().slice(0, 10);
    }

    function logNewDocument() {
        const type = document.getElementById('docType').value;
        const source = document.getElementById('sourceOffice').value;
        const forwarder = document.getElementById('forwarderOffice').value;
        const details = document.getElementById('docDetails').value.trim();

        if (!type || !source || !forwarder || !details) {
            alert(`To create a NEW document ID, you must fill out all required fields in the form below.`);
            return false;
        }
        
        const docId = generateTrackingID();

        const newDoc = {
            id: docId, 
            type: type,
            sourceOffice: source,
            dateReceived: getCurrentDateOnly(),
            docDetails: details,
            dateReleased: '',
            forwarderOffice: forwarder, 
            status: "Received",
            loggedBy: getCurrentUser(), // Logged by Name
            loggedOffice: getCurrentOffice() // Logged by Office
        };

        documents.push(newDoc);
        document.getElementById('documentForm').reset();
        saveDocuments(); 
        displayDocuments();

        alert(`‚úÖ NEW Document successfully logged by ${getCurrentUser()} (${getCurrentOffice()})! Generated Tracking ID: ${docId}`);
        return true;
    }

    // --- Action Logic (Updated to use getCurrentOffice for logging) ---

    function handleAction(actionType) {
        const docIdInput = document.getElementById('docId');
        const docId = docIdInput.value.trim().toUpperCase();
        docIdInput.value = ''; 

        if (actionType === 'NEW_DOC') {
            logNewDocument();
            return;
        }

        if (!docId) {
            alert("Please enter the full Tracking ID to update or release the document.");
            return;
        }
        
        const docIndex = documents.findIndex(doc => doc.id === docId);

        if (docIndex === -1) {
            alert(`‚ùå Error: Document ID ${docId} not found. Please verify the ID is correct.`);
            return;
        }

        const doc = documents[docIndex];
        
        const action = prompt(`Document ID ${docId} is currently **${doc.status.toUpperCase()}**.\n\nEnter 'RELEASE' to set the release date and specify a new office.\nEnter 'DELETE' to remove this document from the log.`);

        if (action && action.toUpperCase() === 'RELEASE') {
            
            if (doc.status === 'Released') {
                alert(`‚ö†Ô∏è Document ID ${docId} is ALREADY RELEASED. No action taken.`);
                return;
            }
            
            // Use the list of offices defined in the New Document Details form
            const officeSelect = document.getElementById('forwarderOffice');
            const options = Array.from(officeSelect.options).filter(opt => opt.value !== '').map(opt => opt.value);
            const officeList = options.join('\n- ');
            
            let newOffice = prompt(`Document ID ${docId} is currently **${doc.status.toUpperCase()}**.\n\n***RELEASE ACTION: Select New Destination***\n\nEnter the **EXACT** name of the New Destination Office:\n\nAvailable Offices:\n- ${officeList}`);

            if (newOffice) {
                newOffice = newOffice.trim();
                const validOffice = options.find(o => o.toUpperCase() === newOffice.toUpperCase());

                if (validOffice) {
                    doc.dateReleased = getCurrentDateOnly();
                    doc.forwarderOffice = validOffice; 
                    doc.status = 'Released';
                    doc.loggedBy = getCurrentUser(); 
                    doc.loggedOffice = getCurrentOffice();
                    saveDocuments(); 
                    alert(`‚úÖ Document ID ${docId} has been **RELEASED** by ${getCurrentUser()} (${getCurrentOffice()}) and forwarded to: ${validOffice}.`);
                } else {
                    alert(`‚ùå Error: Invalid office name entered ("${newOffice}"). Please choose an existing office from the list.`);
                }
            } else {
                alert("Release action cancelled.");
            }

        } else if (action && action.toUpperCase() === 'DELETE') {
            const confirmDelete = confirm(`Are you sure you want to DELETE Document ID ${docId}? This action cannot be undone. Logged by: ${getCurrentUser()}`);
            if (confirmDelete) {
                documents.splice(docIndex, 1);
                saveDocuments(); 
                alert(`üóëÔ∏è Document ID ${docId} has been DELETED by ${getCurrentUser()}.`);
            }
        } else {
            alert("Action cancelled or invalid option selected.");
        }

        displayDocuments();
    }


    // --- Table Rendering (UPDATED for Filtering) ---

    function displayDocuments() {
        const listBody = document.getElementById('documentList');
        listBody.innerHTML = '';
        
        const currentOffice = getCurrentOffice();
        
        // FILTERING LOGIC
        const filteredDocuments = documents.filter(doc => {
            // If the user selects 'All Offices', show everything (Admin View)
            if (currentOffice === 'All Offices') {
                return true;
            }
            // Otherwise, only show documents currently destined for the user's office.
            // Note: If the document is already "Released" and sent to a *different* office, it won't show up here,
            // as its current destination (`forwarderOffice`) should reflect the next step.
            return doc.forwarderOffice === currentOffice;
        });

        // Display the filtered documents (newest first)
        filteredDocuments.slice().reverse().forEach(doc => {
            const row = listBody.insertRow();
            
            row.insertCell().textContent = doc.id;
            
            const barcodeCell = row.insertCell();
            barcodeCell.className = 'barcode-cell';
            barcodeCell.innerHTML = generateBarcodeSVG(doc.id);

            row.insertCell().textContent = doc.type;
            row.insertCell().textContent = doc.sourceOffice;
            row.insertCell().textContent = doc.dateReceived;
            
            // Highlight the current destination if it matches the logged-in office (Visual cue)
            const destinationCell = row.insertCell();
            destinationCell.textContent = doc.forwarderOffice; 
            if (doc.forwarderOffice === currentOffice) {
                destinationCell.style.backgroundColor = '#d4edda'; // Light green highlight
            }

            row.insertCell().textContent = doc.dateReleased || 'Pending';
            
            const statusCell = row.insertCell();
            statusCell.textContent = doc.status;
            statusCell.style.fontWeight = 'bold';
            
            let statusColor = '#007bff'; 
            if (doc.status === 'Received') statusColor = '#28a745'; 
            if (doc.status === 'Released') statusColor = '#dc3545'; 
            
            statusCell.style.color = statusColor;
            
            // Display both Name and Office in the "Logged By" column
            row.insertCell().textContent = `${doc.loggedBy} (${doc.loggedOffice})`; 

            // Render barcode after the cell is added to the DOM
            setTimeout(() => renderBarcode(doc.id), 0);
        });
        
        if (filteredDocuments.length === 0) {
            listBody.innerHTML = `<tr style="color: #777;"><td colspan="9" style="text-align: center;">No documents currently received by the **${currentOffice}** office.</td></tr>`;
        }
    }

    // --- Initialization: Load and Display Documents on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        loadDocuments();
        console.log(`[Document Tracker] Loaded ${documents.length} documents from Local Storage.`);
        // Call checkLogin, which in turn calls showApp and displayDocuments with filtering
        checkLogin(); 
    });
</script>

</body>
</html>
