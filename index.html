<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Tracker (YYYY-SSSSS) - Cloud Log</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f7f7f7; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 5px; }
        
        /* Header for Office Name and Controls */
        .app-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 2px solid #007bff; 
            margin-bottom: 20px; 
            font-size: 1.1em;
        }
        .app-header p { margin: 0; font-weight: bold; color: #333; }
        .app-header span { color: #dc3545; }
        .logout-btn { background-color: #6c757d; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background-color: #5a6268; }

        /* Login Screen Styling */
        #login-container {
            display: none; 
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #e6f0ff;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        .login-box h2 { color: #007bff; margin-top: 0; }
        .login-box select, .login-box input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .login-box button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            margin-top: 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover { background-color: #218838; }

        /* Form Container (3 columns) */
        .form-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px; background-color: #e6f0ff; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #0056b3; }
        .form-container input:not([type="date"]), .form-container select, .form-container input[type="date"] { 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        
        /* Action Panel */
        .action-panel { display: flex; flex-direction: column; gap: 20px; padding: 20px; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 30px; background-color: #fff8e1; }
        .action-controls { display: flex; align-items: flex-end; gap: 15px; }
        .action-controls .input-group { flex-grow: 1; }
        .action-controls input { width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 4px; font-size: 16px; font-weight: bold; }
        
        .action-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .accept-btn { background-color: #28a745; color: white; }
        .release-btn { background-color: #dc3545; color: white; }
        .accept-btn:hover { background-color: #218838; }
        .release-btn:hover { background-color: #c82333; }

        /* Table and Persistence Controls */
        #documentTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #documentTable th, #documentTable td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 14px; }
        #documentTable th { background-color: #007bff; color: white; }
        #documentTable tr:nth-child(even) { background-color: #f2f2f2; }

        /* Barcode Cell Styling */
        .barcode-cell { text-align: center; }
        .barcode-cell svg { max-width: 150px; height: 50px; } 
        .barcode-cell .simple-id { 
            display: block; 
            font-weight: bold; 
            font-size: 14px; 
            margin-top: -5px; 
            color: #007bff;
        }
        
        .persistence-controls { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e6f0ff;
            border-radius: 8px;
        }

        .persistence-controls button {
            padding: 8px 15px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #saveDataBtn { background-color: #ffc107; color: #333; }
        #saveDataBtn:hover { background-color: #e0a800; }
        #clearDataBtn { background-color: #6c757d; color: white; }
        #clearDataBtn:hover { background-color: #5a6268; }
        
        /* Logged By column width */
        #documentTable th:last-child { width: 100px; } 

        /* History Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px; 
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .history-table th, .history-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
        .history-table th { background-color: #0056b3; color: white; }
        
        /* Deadline overdue status */
        .deadline-overdue {
            background-color: #ffcccc !important; /* Light red */
            font-weight: bold;
            color: #dc3545;
        }
        /* Loading indicator styling */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-size: 1.5em;
            color: #007bff;
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay" style="display:none;">
    Loading/Saving Data... Please wait.
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modalTitle">Document History Log</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date/Time</th>
                    <th>Action</th>
                    <th>To Office</th>
                    <th>Processed By</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                </tbody>
        </table>
    </div>
</div>
<div id="login-container">
    <div class="login-box">
        <h2>Document Tracker Access</h2>
        <p>Please enter your name and select your office to begin.</p>
        
        <input type="text" id="nameInput" placeholder="Enter Your Name (e.g., J. Dela Cruz)" required>
        
        <select id="officeSelect" required>
            <option value="" disabled selected>Select Office</option>
            </select>
        
        <button onclick="attemptLogin()">Log In</button>
        <p style="font-size: 10px; color: #dc3545; margin-top: 20px;">
            ‚ö†Ô∏è If selecting **All Offices**, you will be prompted for the administrator password.
        </p>
    </div>
</div>

<div id="app-container" style="display:none;">
    <div class="container">
        
        <div class="app-header">
            <h1 style="margin: 0;">Automated Document Tracker üìÑ (ID Format: YYYY-SSSSS)</h1>
            <p>
                User: <span id="loggedInUserDisplay">N/A</span> | Office: <span id="loggedInOfficeDisplay" style="color: #007bff;">N/A</span>
                <button class="logout-btn" onclick="logout()">Log Out</button>
            </p>
        </div>

        <div class="action-panel">
            <h2>Document Action: Auto-Generation and Status Update</h2>

            <div class="action-controls">
                <div class="input-group">
                    <label for="docId">Enter Full Tracking ID to Update/Release (e.g., YYYY-SSSSS):</label>
                    <input type="text" id="docId" placeholder="e.g., 2026-00001">
                </div>
                
                <div class="action-buttons">
                    <button class="accept-btn" onclick="handleAction('NEW_DOC')">Create NEW Unique Document ID</button>
                    <button class="release-btn" onclick="handleAction('RELEASE')">Release Document (Log New Step)</button>
                </div>
            </div>
        </div>

        <div id="documentForm" class="form-container">
            <h2>New Document Details (Required for **NEW** Log Action)</h2>
            <div class="form-group">
                <label for="docType">Document Type:</label>
                <select id="docType" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Memorandum">Memorandum</option>
                    <option value="Request">Request</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Letter">Letter</option>
                    <option value="PSO">PSO</option>
                    <option value="Certificate">Certificate</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sourceOffice">Source Office:</label>
                <select id="sourceOffice" required>
                    <option value="" disabled selected>Select Source</option>
                </select>
            </div>

            <div class="form-group">
                <label for="docDetails">Brief Subject/Details:</label>
                <input type="text" id="docDetails" required>
            </div>

            <div class="form-group">
                <label for="forwarderOffice">Initial Office Destination (First Stop):</label> 
                <select id="forwarderOffice" required>
                    <option value="" disabled selected>Select Destination</option>
                </select>
            </div>

            <div class="form-group">
                <label for="deadlineDate">Deadline Date (Calendar Picker):</label>
                <input type="date" id="deadlineDate" required>
            </div>
            
            <div class="form-group">
                <label>Date Logged (Auto-filled):</label>
                <input type="text" disabled placeholder="Will be set upon New Document ID">
            </div>
        </div>

        <h2 id="tableHeader">Document Log (Showing Files for Your Office)</h2>
        
        <div class="persistence-controls">
            <button id="saveDataBtn" onclick="saveDocuments(true)">Save Log Now üíæ</button>
            <button id="clearDataBtn" onclick="clearDocuments()">Clear ALL Log Data ‚ö†Ô∏è</button>
        </div>

        <table id="documentTable">
            <thead>
                <tr>
                    <th>Tracking ID (YYYY-SSSSS)</th>
                    <th>Barcode</th>
                    <th>Type / Subject</th>
                    <th>Source Office</th>
                    <th>Initial Destination</th>
                    <th>Deadline</th>
                    <th>Current Status</th>
                    <th>Log History</th>
                </tr>
            </thead>
            <tbody id="documentList">
                </tbody>
        </table>
    </div>
</div>

<script>
    // --------------------------------------------------------------------------------
    // --- IMPORTANT CONFIGURATION ---
    // --------------------------------------------------------------------------------
    const ADMIN_PASSWORD = 'admin123'; // !!! CHANGE THIS PASSWORD !!!
    
    // !!! YOU MUST REPLACE THIS PLACEHOLDER URL !!!
    // This is the URL of the Google Apps Script Web App you will deploy in the next step.
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzSTHj-ynnoz1ZWJGqCX0tTxgj2Pc8gO1YqeEQ2EXmoedt-PDGA5_LL-bHcWsU9HaZpAg/exec';
    
    const OFFICE_OPTIONS = [
        "PARPO",
        "STOD",
        "LEGAL",
        "LTSP",
        "RECORDS",
        "ARBDSP",
        "Planning Section",
        "Finance Unit",
        "Regional Office V",
        "Central Office",
        // The following is the admin view option
        "All Offices" 
    ];

    // --- Global State Variables ---
    let documents = []; 
    let currentSequence = 0;
    let currentYear = new Date().getFullYear().toString();
    
    // --- Utility Functions ---
    
    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }


    // --------------------------------------------------------------------------------
    // --- PERSISTENCE FUNCTIONS (Cloud Integration) ---
    // --------------------------------------------------------------------------------
    
    // 1. LOAD DATA (GET request to GAS)
    async function loadDocuments() {
        showLoading();
        try {
            if (API_ENDPOINT === 'YOUR_WEB_APP_URL') {
                alert("ERROR: API_ENDPOINT is not set. Data cannot be loaded from the cloud. Please follow the Google Apps Script instructions.");
                documents = [];
                currentSequence = 0;
                hideLoading();
                return;
            }

            const response = await fetch(API_ENDPOINT, { method: 'GET' });
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();

            // Store documents and sequence globally
            documents = data.documents || [];
            currentSequence = data.sequence || 0;
            currentYear = data.year || new Date().getFullYear().toString();
            
            console.log(`[Cloud Tracker] Loaded ${documents.length} documents.`);

        } catch (e) { 
            console.error("Error loading documents from the cloud:", e); 
            alert(`Error loading data: ${e.message}. Using empty log.`);
            documents = [];
            currentSequence = 0;
        } finally {
            hideLoading();
        }
    }

    // 2. SAVE DATA (POST request to GAS)
    // The `manual` flag determines if we show a success message
    async function saveDocuments(manual = false) {
        showLoading();
        const dataToSend = {
            documents: documents,
            sequence: currentSequence,
            year: currentYear
        };

        try {
            if (API_ENDPOINT === 'YOUR_WEB_APP_URL') {
                 throw new Error("API_ENDPOINT is not set. Data cannot be saved.");
            }
            
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            });

            if (!response.ok) throw new Error(`Server returned status: ${response.status}`);
            
            const result = await response.json();
            if (result.status !== 'success') throw new Error(`GAS Script Error: ${result.message}`);

            if (manual) {
                alert("‚úÖ Log data successfully saved to Google Sheet!");
            }

        } catch (e) { 
            console.error("Error saving documents to the cloud:", e); 
            alert(`‚ùå Critical Save Error: ${e.message}. Check your API URL and Google Apps Script deployment.`);
        } finally {
            hideLoading();
        }
    }

    // 3. CLEAR DATA 
    async function clearDocuments() {
        if (confirm("WARNING: This will permanently DELETE ALL logged documents and reset the tracking ID counter on the CLOUD. Are you absolutely sure?")) {
            documents = []; 
            currentSequence = 0;
            await saveDocuments(false); 
            displayDocuments();
            alert("All cloud log data has been cleared.");
        }
    }


    // --- Other Functions (Mostly Unchanged, but now rely on save/load) ---

    // Dynamic Office Dropdown Population
    function populateOfficeDropdowns() {
        const officeSelect = document.getElementById('officeSelect');
        const sourceOfficeSelect = document.getElementById('sourceOffice');
        const forwarderOfficeSelect = document.getElementById('forwarderOffice');
        
        officeSelect.innerHTML = '<option value="" disabled selected>Select Office</option>';
        sourceOfficeSelect.innerHTML = '<option value="" disabled selected>Select Source</option>';
        forwarderOfficeSelect.innerHTML = '<option value="" disabled selected>Select Destination</option>';
        
        const functionalOffices = OFFICE_OPTIONS.filter(o => o !== "All Offices");

        // 1. Populate Login/User Office Selector (Includes Admin)
        OFFICE_OPTIONS.forEach(office => {
            const option = document.createElement('option');
            option.value = office;
            option.textContent = office;
            officeSelect.appendChild(option);
        });

        // 2. Populate Source/Destination Selectors (Functional Offices Only)
        functionalOffices.forEach(office => {
            const sourceOption = document.createElement('option');
            sourceOption.value = office;
            sourceOption.textContent = office;
            sourceOfficeSelect.appendChild(sourceOption);

            const forwarderOption = document.createElement('option');
            forwarderOption.value = office;
            forwarderOption.textContent = office;
            forwarderOfficeSelect.appendChild(forwarderOption);
        });
    }

    // Modal Functions
    function openModal(docId) {
        const doc = documents.find(d => d.id === docId);
        if (!doc) return;

        document.getElementById('modalTitle').textContent = `History Log for ID: ${docId}`;
        const historyBody = document.getElementById('historyTableBody');
        historyBody.innerHTML = '';

        doc.history.forEach(log => {
            const row = historyBody.insertRow();
            row.insertCell().textContent = log.timestamp;
            row.insertCell().textContent = log.action;
            row.insertCell().textContent = log.destinationOffice;
            row.insertCell().textContent = `${log.loggedBy} (${log.loggedOffice})`;
        });

        document.getElementById('historyModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('historyModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }


    // Login/Session Functions (Uses Session Storage for user session, but data is cloud-based)
    function checkLogin() {
        const loggedInName = sessionStorage.getItem('docTrackerName');
        const loggedInOffice = sessionStorage.getItem('docTrackerOffice');

        if (loggedInName && loggedInOffice) {
            document.getElementById('loggedInUserDisplay').textContent = loggedInName;
            document.getElementById('loggedInOfficeDisplay').textContent = loggedInOffice;
            
            const headerText = (loggedInOffice === 'All Offices') 
                ? "Document Log (Showing ALL Files - ADMIN VIEW)" 
                : `Document Log (Showing Files for ${loggedInOffice})`;
            document.getElementById('tableHeader').textContent = headerText;
            
            showApp();
            displayDocuments(); 
        } else {
            showLogin();
        }
    }
    
    function showApp() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
    }
    
    function showLogin() {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }
    
    function attemptLogin() {
        const name = document.getElementById('nameInput').value.trim();
        const office = document.getElementById('officeSelect').value; 

        if (!name || !office) {
            alert("Please enter your name and select your office.");
            return;
        }

        if (office === 'All Offices') {
            const password = prompt("ADMIN VIEW SELECTED: Please enter the administrator password:");
            if (password !== ADMIN_PASSWORD) {
                alert("Incorrect password. Access denied.");
                return;
            }
        }
        
        sessionStorage.setItem('docTrackerName', name); 
        sessionStorage.setItem('docTrackerOffice', office); 
        checkLogin();
    }
    
    function logout() {
        if (confirm("Are you sure you want to log out?")) {
            sessionStorage.removeItem('docTrackerName');
            sessionStorage.removeItem('docTrackerOffice');
            showLogin();
        }
    }
    
    function getCurrentUser() {
        return sessionStorage.getItem('docTrackerName') || 'UNKNOWN';
    }
    
    function getCurrentOffice() {
        return sessionStorage.getItem('docTrackerOffice') || 'UNKNOWN';
    }


    // Tracking ID Generation Logic (Uses global variables managed by cloud)

    function getSequence() {
        const newYear = new Date().getFullYear().toString();
        
        // Check for year change (resets sequence)
        if (currentYear !== newYear) {
            currentYear = newYear;
            currentSequence = 0;
        }

        currentSequence++;
        return String(currentSequence).padStart(5, '0');
    }

    function generateTrackingID() {
        const sequencePart = getSequence();
        return `${currentYear}-${sequencePart}`;
    }
    
    // Barcode Functions (Unchanged)
    function generateBarcodeSVG(id) {
        const parts = id.split('-');
        let simpleId = 'N/A';
        if (parts.length === 2) {
            const sequence5Digit = parts[1];
            simpleId = sequence5Digit.slice(-4);
        }
        return `<svg id="barcode-${id}"></svg><span class="simple-id">${simpleId}</span>`;
    }

    function renderBarcode(id) {
        if (document.getElementById(`barcode-${id}`)) {
            try {
                JsBarcode(`#barcode-${id}`, id, {
                    format: "CODE128", 
                    displayValue: false, 
                    width: 1.5, 
                    height: 50
                });
            } catch (e) {
                console.error("Error rendering barcode:", e);
            }
        }
    }

    // Document Logging
    function getCurrentDateTime() {
        const now = new Date();
        const date = now.toISOString().slice(0, 10);
        const time = now.toTimeString().slice(0, 8);
        return `${date} ${time}`;
    }

    async function logNewDocument() {
        const type = document.getElementById('docType').value;
        const source = document.getElementById('sourceOffice').value;
        const initialDestination = document.getElementById('forwarderOffice').value;
        const details = document.getElementById('docDetails').value.trim();
        const deadline = document.getElementById('deadlineDate').value; 

        if (!type || !source || !initialDestination || !details || !deadline) {
            alert(`To create a NEW document ID, you must fill out ALL required fields in the form below, including the Deadline.`);
            return false;
        }
        
        // ID Generation must happen BEFORE saving, as it increments the global sequence
        const docId = generateTrackingID();
        const currentUser = getCurrentUser();
        const currentOffice = getCurrentOffice();

        const newDoc = {
            id: docId, 
            type: type,
            sourceOffice: source,
            docDetails: details,
            deadline: deadline, 
            history: [{
                timestamp: getCurrentDateTime(),
                action: 'Received (Initial Log)',
                destinationOffice: initialDestination,
                loggedBy: currentUser,
                loggedOffice: currentOffice
            }]
        };

        documents.push(newDoc);
        document.getElementById('documentForm').reset();
        
        await saveDocuments(); // Save to cloud
        
        displayDocuments();

        alert(`‚úÖ NEW Document successfully logged by ${currentUser} (${currentOffice})! Generated Tracking ID: ${docId}`);
        return true;
    }

    // Action Logic
    async function handleAction(actionType) {
        const docIdInput = document.getElementById('docId');
        const docId = docIdInput.value.trim().toUpperCase();
        docIdInput.value = ''; 

        if (actionType === 'NEW_DOC') {
            await logNewDocument();
            return;
        }

        if (!docId) {
            alert("Please enter the full Tracking ID to update or release the document.");
            return;
        }
        
        const docIndex = documents.findIndex(doc => doc.id === docId);

        if (docIndex === -1) {
            alert(`‚ùå Error: Document ID ${docId} not found. Please verify the ID is correct.`);
            return;
        }

        const doc = documents[docIndex];
        const currentUserOffice = getCurrentOffice();
        
        const lastLog = doc.history[doc.history.length - 1];
        const currentDestination = lastLog.destinationOffice;
        
        // SECURITY CHECK
        if (currentUserOffice !== 'All Offices' && currentDestination !== currentUserOffice) {
            alert(`‚ùå ACCESS DENIED: This file is currently logged to be at ${currentDestination}. Only that office can perform the Release action.`);
            return;
        }

        const action = prompt(`Document ID ${docId} is currently logged to be at **${currentDestination}**.\n\nEnter 'RELEASE' to log the document's movement to the next office.\nEnter 'COMPLETE' to mark the file as finalized/completed by your office.\nEnter 'DELETE' to remove this document from the log.`);

        if (action && action.toUpperCase() === 'RELEASE') {
            
            const functionalOffices = OFFICE_OPTIONS.filter(o => o !== "All Offices");
            const officeList = functionalOffices.join('\n- ');
            
            let newOffice = prompt(`***RELEASE ACTION: Select New Destination***\n\nEnter the **EXACT** name of the New Destination Office:\n\nAvailable Offices:\n- ${officeList}`);

            if (newOffice) {
                newOffice = newOffice.trim();
                const validOffice = functionalOffices.find(o => o.toUpperCase() === newOffice.toUpperCase());

                if (validOffice) {
                    doc.history.push({
                        timestamp: getCurrentDateTime(),
                        action: 'Released/Forwarded',
                        destinationOffice: validOffice,
                        loggedBy: getCurrentUser(),
                        loggedOffice: currentUserOffice
                    });
                    
                    await saveDocuments(); 
                    alert(`‚úÖ Document ID ${docId} has been **RELEASED** by ${currentUserOffice} and forwarded to: ${validOffice}.`);
                } else {
                    alert(`‚ùå Error: Invalid office name entered ("${newOffice}"). Please choose an existing office from the list.`);
                }
            } else {
                alert("Release action cancelled.");
            }
        } 
        else if (action && action.toUpperCase() === 'COMPLETE') {
            doc.history.push({
                timestamp: getCurrentDateTime(),
                action: 'Completed/Archived',
                destinationOffice: 'COMPLETED/ARCHIVE',
                loggedBy: getCurrentUser(),
                loggedOffice: currentUserOffice
            });
            await saveDocuments();
            alert(`‚úÖ Document ID ${docId} has been **COMPLETED** and marked for Archive by ${currentUserOffice}.`);
        }
        else if (action && action.toUpperCase() === 'DELETE') {
            const confirmDelete = confirm(`Are you sure you want to DELETE Document ID ${docId}? This action cannot be undone. Logged by: ${getCurrentUser()}`);
            if (confirmDelete) {
                documents.splice(docIndex, 1);
                await saveDocuments(); 
                alert(`üóëÔ∏è Document ID ${docId} has been DELETED by ${getCurrentUser()}.`);
            }
        } else {
            alert("Action cancelled or invalid option selected.");
        }

        displayDocuments();
    }


    // Table Rendering (Unchanged)
    function displayDocuments() {
        const listBody = document.getElementById('documentList');
        listBody.innerHTML = '';
        
        const currentOffice = getCurrentOffice();
        const today = new Date().toISOString().slice(0, 10);

        const getCurrentStatus = (doc) => {
            if (!doc.history || doc.history.length === 0) {
                return { office: 'N/A', status: 'Error', loggedBy: 'N/A' };
            }
            const lastLog = doc.history[doc.history.length - 1];
            return {
                office: lastLog.destinationOffice,
                status: lastLog.action,
                loggedBy: `${lastLog.loggedBy} (${lastLog.loggedOffice})`,
                timestamp: lastLog.timestamp 
            };
        };

        const filteredDocuments = documents.filter(doc => {
            const status = getCurrentStatus(doc);
            if (currentOffice === 'All Offices') {
                return true;
            }
            return status.office === currentOffice;
        });

        filteredDocuments.slice().reverse().forEach(doc => {
            const status = getCurrentStatus(doc);
            const row = listBody.insertRow();
            
            row.insertCell().textContent = doc.id;
            
            const barcodeCell = row.insertCell();
            barcodeCell.className = 'barcode-cell';
            barcodeCell.innerHTML = generateBarcodeSVG(doc.id);

            row.insertCell().innerHTML = `<strong>${doc.type}</strong><br><small>${doc.docDetails}</small>`;
            
            row.insertCell().textContent = doc.sourceOffice;
            
            row.insertCell().textContent = doc.history[0].destinationOffice; 
            
            const deadlineCell = row.insertCell();
            deadlineCell.textContent = doc.deadline;
            
            let isOverdue = false;
            if (doc.deadline && status.office !== 'COMPLETED/ARCHIVE' && doc.deadline < today) {
                deadlineCell.classList.add('deadline-overdue');
                isOverdue = true;
            }
            
            const currentStatusCell = row.insertCell();
            
            let statusText = status.office;
            if (status.office === 'COMPLETED/ARCHIVE') {
                statusText = 'FINALIZED';
                currentStatusCell.style.backgroundColor = '#d1e7dd'; 
            } else if (isOverdue) {
                currentStatusCell.style.backgroundColor = '#f8d7da'; 
            } else if (status.office === currentOffice) {
                currentStatusCell.style.backgroundColor = '#fff3cd'; 
            }

            currentStatusCell.innerHTML = `<strong>${statusText}</strong><br><small>Last Action: ${status.action} by ${status.loggedBy}</small>`;
            
            const historyCell = row.insertCell();
            historyCell.innerHTML = `<button onclick="openModal('${doc.id}')">View Log</button>`;
            
            setTimeout(() => renderBarcode(doc.id), 0);
        });
        
        if (filteredDocuments.length === 0) {
            listBody.innerHTML = `<tr style="color: #777;"><td colspan="8" style="text-align: center;">No documents currently requiring action by the **${currentOffice}** office.</td></tr>`;
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        populateOfficeDropdowns(); 
        await loadDocuments(); // Load data from cloud first
        checkLogin(); 
    });
</script>

</body>
</html>

