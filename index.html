<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Status Tracker (26-MM-XXXX Format) - With Login</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f7f7f7; }
        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 5px; }
        
        /* Header for Username and Controls */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        .app-header p { margin: 0; font-weight: bold; color: #333; }
        .app-header span { color: #dc3545; }
        .logout-btn { background-color: #6c757d; color: white; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background-color: #5a6268; }

        /* Login Screen Styling */
        #login-container {
            display: none; /* Controlled by JS */
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #e6f0ff;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        .login-box h2 { color: #007bff; margin-top: 0; }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .login-box button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .login-box button:hover { background-color: #218838; }

        /* Rest of the Existing Styles */
        .form-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 30px; background-color: #e6f0ff; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: bold; color: #0056b3; }
        .form-container input, .form-container select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Scanner Panel */
        .scanner-panel { display: flex; flex-direction: column; gap: 20px; padding: 20px; border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 30px; background-color: #fff8e1; }
        .scanner-controls { display: flex; align-items: flex-end; gap: 15px; }
        .scanner-controls .input-group { flex-grow: 1; }
        .scanner-controls input { width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 4px; font-size: 16px; font-weight: bold; }
        
        #reader { width: 100%; max-width: 400px; border: 1px solid #ccc; margin: 0 auto 10px; }
        
        .action-buttons button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .accept-btn { background-color: #28a745; color: white; }
        .release-btn { background-color: #dc3545; color: white; }
        .start-btn { background-color: #007bff; color: white; }
        .start-btn:hover { background-color: #0056b3; }
        .accept-btn:hover { background-color: #218838; }
        .release-btn:hover { background-color: #c82333; }

        /* Table and Persistence Controls */
        #documentTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #documentTable th, #documentTable td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 14px; }
        #documentTable th { background-color: #007bff; color: white; }
        #documentTable tr:nth-child(even) { background-color: #f2f2f2; }
        .barcode-cell { text-align: center; }
        .barcode-cell svg { max-width: 150px; height: 50px; } 

        .persistence-controls { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e6f0ff;
            border-radius: 8px;
        }

        .persistence-controls button {
            padding: 8px 15px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #saveDataBtn { background-color: #ffc107; color: #333; }
        #saveDataBtn:hover { background-color: #e0a800; }
        #clearDataBtn { background-color: #6c757d; color: white; }
        #clearDataBtn:hover { background-color: #5a6268; }
        
        /* Logged By column width */
        #documentTable th:last-child { width: 100px; } 
    </style>
</head>
<body>

<div id="login-container">
    <div class="login-box">
        <h2>Document Tracker Access</h2>
        <p>Please enter your **Username** to use the system and log changes.</p>
        <input type="text" id="usernameInput" placeholder="Enter your name or initials (e.g., JDELA CRUZ)">
        <button onclick="attemptLogin()">Log In</button>
        <p style="font-size: 10px; color: #dc3545; margin-top: 20px;">
            ‚ö†Ô∏è This is for internal logging only. No password required.
        </p>
    </div>
</div>

<div id="app-container" style="display:none;">
    <div class="container">
        
        <div class="app-header">
            <h1 style="margin: 0;">Document Status Tracker üìÑ</h1>
            <p>
                Logged in as: <span id="loggedInUserDisplay">N/A</span> 
                <button class="logout-btn" onclick="logout()">Log Out</button>
            </p>
        </div>

        <div class="scanner-panel">
            <h2>Barcode Scanner & Status Update</h2>

            <div id="reader"></div> 
            <p id="scannerMessage" style="text-align: center; font-weight: bold; color: #555;">Scanner stopped. Click 'Start Scanner' to activate your camera and grant permission.</p>

            <div class="scanner-controls">
                <button id="startScanBtn" class="start-btn" onclick="startScanner()">Start Scanner</button>
                <button id="stopScanBtn" class="release-btn" onclick="stopScanner()" style="display: none;">Stop Scanner</button>
                
                <div class="input-group" style="flex-grow: 1;">
                    <label for="scannerId">Decoded Tracking ID / Manual Entry:</label>
                    <input type="text" id="scannerId" placeholder="ID appears here (e.g., 26-12-0001)">
                </div>
                
                <div class="action-buttons">
                    <button class="accept-btn" onclick="handleScanAction('ACCEPT')">Accept Document (Initial Log/Update)</button>
                    <button class="release-btn" onclick="handleScanAction('RELEASE')">Release Document (Status Update)</button>
                </div>
            </div>
        </div>

        <div id="documentForm" class="form-container">
            <h2>New Document Details (Required for Initial Log)</h2>
            <div class="form-group">
                <label for="docType">Document Type:</label>
                <select id="docType" required>
                    <option value="" disabled selected>Select Type</option>
                    <option value="Memorandum">Memorandum</option>
                    <option value="Request">Request</option>
                    <option value="Complaint">Complaint</option>
                    <option value="Letter">Letter</option>
                    <option value="PSO">PSO</option>
                    <option value="Certificate">Certificate</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sourceOffice">Source Office:</label>
                <select id="sourceOffice" required>
                    <option value="" disabled selected>Select Source</option>
                    <option value="Legal Division">Legal Division</option>
                    <option value="Planning Section">Planning Section</option>
                    <option value="Finance Unit">Finance Unit</option>
                    <option value="Regional Office V">Regional Office V</option>
                    <option value="Central Office">Central Office</option>
                </select>
            </div>

            <div class="form-group">
                <label for="docDetails">Brief Subject/Details:</label>
                <input type="text" id="docDetails" required>
            </div>

            <div class="form-group">
                <label for="forwarderOffice">Forwarder Office (Initial Destination for New Log):</label> 
                <select id="forwarderOffice" required>
                    <option value="" disabled selected>Select Destination</option>
                    <option value="Legal Division">Legal Division</option>
                    <option value="Planning Section">Planning Section</option>
                    <option value="Finance Unit">Finance Unit</option>
                    <option value="Regional Office V">Regional Office V</option>
                    <option value="Records Section">Records Section</option>
                </select>
            </div>

            <div class="form-group">
                <label>Date Received (Auto-filled on 'Accept'):</label>
                <input type="text" disabled placeholder="Will be set upon Acceptance">
            </div>
            
            <div class="form-group">
                <label>Date Released (Auto-filled on 'Release'):</label>
                <input type="text" disabled placeholder="N/A">
            </div>
        </div>

        <h2>Document Log</h2>
        
        <div class="persistence-controls">
            <button id="saveDataBtn" onclick="saveDocuments()">Manually Save Log üíæ</button>
            <button id="clearDataBtn" onclick="clearDocuments()">Clear All Log Data ‚ö†Ô∏è</button>
        </div>

        <table id="documentTable">
            <thead>
                <tr>
                    <th>Tracking ID</th>
                    <th>Barcode</th>
                    <th>Type</th>
                    <th>Source Office</th>
                    <th>Date Received</th>
                    <th>Last Destination / Current Office</th>
                    <th>Date Released</th>
                    <th>Status</th>
                    <th>Logged By</th> </tr>
            </thead>
            <tbody id="documentList">
                </tbody>
        </table>
    </div>
</div>

<script>
    // --- Data Storage Keys ---
    const COUNTER_KEY = 'docTrackerSequence';
    const DOCUMENTS_KEY = 'docTrackerDocuments'; 
    let documents = []; 
    let html5QrCode = null; 

    // --- Login/Session Functions ---
    
    function checkLogin() {
        const loggedInUser = sessionStorage.getItem('docTrackerUser');
        if (loggedInUser) {
            document.getElementById('loggedInUserDisplay').textContent = loggedInUser;
            showApp();
        } else {
            showLogin();
        }
    }

    function showApp() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
    }

    function showLogin() {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
    }

    function attemptLogin() {
        const username = document.getElementById('usernameInput').value.trim().toUpperCase();
        if (username) {
            sessionStorage.setItem('docTrackerUser', username);
            document.getElementById('loggedInUserDisplay').textContent = username;
            showApp();
        } else {
            alert("Please enter a username.");
        }
    }

    function logout() {
        if (confirm("Are you sure you want to log out?")) {
            sessionStorage.removeItem('docTrackerUser');
            showLogin();
        }
    }

    function getCurrentUser() {
        // Retrieve username for logging purposes
        return sessionStorage.getItem('docTrackerUser') || 'UNKNOWN';
    }

    // --- Persistence Functions (Robust) ---

    function loadDocuments() {
        try {
            const storedDocs = localStorage.getItem(DOCUMENTS_KEY);
            if (storedDocs) {
                const parsedDocs = JSON.parse(storedDocs);
                if (Array.isArray(parsedDocs)) {
                    documents = parsedDocs;
                }
            }
        } catch (e) {
            console.error("Error loading documents from Local Storage:", e);
            // Alert removed as it's not needed when running on a proper web server (GitHub Pages)
        }
    }

    function saveDocuments() {
        try {
            localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
            // Alert removed from auto-save/update process for better user experience
        } catch (e) {
            console.error("Error saving documents to Local Storage:", e);
        }
    }
    
    // Manual save function (retains alert)
    function manualSaveDocuments() {
         try {
            localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
            alert("Log data successfully saved to browser's local storage.");
        } catch (e) {
            console.error("Error saving documents to Local Storage:", e);
            alert("Error: Could not save log data to Local Storage.");
        }
    }

    function clearDocuments() {
        if (confirm("WARNING: This will permanently DELETE ALL logged documents and reset the tracking ID counter. Are you sure?")) {
            localStorage.removeItem(DOCUMENTS_KEY);
            localStorage.removeItem(COUNTER_KEY);
            documents = []; // Clear in-memory array
            displayDocuments();
            alert("All log data has been cleared.");
        }
    }


    // --- Helper Functions ---

    function generateTrackingID() {
        const today = new Date();
        const FIXED_YEAR = '26';
        
        const monthPart = String(today.getMonth() + 1).padStart(2, '0');
        
        let sequence = parseInt(localStorage.getItem(COUNTER_KEY)) || 0;
        sequence++;
        localStorage.setItem(COUNTER_KEY, sequence);

        const seqPart = String(sequence).padStart(4, '0');
        
        return `${FIXED_YEAR}-${monthPart}-${seqPart}`;
    }
    
    function getCurrentDateOnly() {
        // Formats date as YYYY-MM-DD
        return new Date().toISOString().slice(0, 10);
    }

    function generateBarcodeSVG(id) {
        return `<svg id="barcode-${id}"></svg>`;
    }

    function renderBarcode(id) {
        if (document.getElementById(`barcode-${id}`)) {
            try {
                JsBarcode(`#barcode-${id}`, id, {
                    format: "CODE128", 
                    displayValue: false,
                    width: 1,
                    height: 50
                });
            } catch (e) {
                console.error("Error rendering barcode:", e);
            }
        }
    }

    // Function to create and log a new document
    function logNewDocument(docId) {
        const type = document.getElementById('docType').value;
        const source = document.getElementById('sourceOffice').value;
        const forwarder = document.getElementById('forwarderOffice').value;
        const details = document.getElementById('docDetails').value.trim();

        if (!type || !source || !forwarder || !details) {
            alert(`To log a NEW document with ID "${docId}", please fill out all required fields in the form below.`);
            return false;
        }

        const newDoc = {
            id: docId, 
            type: type,
            sourceOffice: source,
            dateReceived: getCurrentDateOnly(),
            docDetails: details,
            dateReleased: '',
            forwarderOffice: forwarder, 
            status: "Received",
            loggedBy: getCurrentUser() 
        };

        documents.push(newDoc);
        document.getElementById('documentForm').reset();
        saveDocuments(); 
        displayDocuments();

        alert(`‚úÖ NEW Document successfully logged by ${getCurrentUser()}! Tracking ID: ${docId}`);
        return true;
    }

    // --- Action Logic (Accept/Release/Delete) ---

    function handleScanAction(actionType) {
        const docIdInput = document.getElementById('scannerId');
        const docId = docIdInput.value.trim().toUpperCase();
        docIdInput.value = ''; 

        if (html5QrCode && html5QrCode.isScanning) {
            stopScanner();
        }
        
        if (!docId && actionType === 'ACCEPT') {
            const newSystemId = generateTrackingID();
            logNewDocument(newSystemId);
            return;
        }

        if (!docId) {
            alert("Please scan or enter a Tracking ID to perform this action.");
            return;
        }
        
        const docIndex = documents.findIndex(doc => doc.id === docId);

        if (docIndex !== -1) {
            const doc = documents[docIndex];
            
            const action = prompt(`Document ID ${docId} is currently **${doc.status.toUpperCase()}**.\n\nEnter 'RELEASE' to set the release date and specify a new office.\nEnter 'DELETE' to remove this document from the log.`);

            if (action && action.toUpperCase() === 'RELEASE') {
                
                if (doc.status === 'Released') {
                    alert(`‚ö†Ô∏è Document ID ${docId} is ALREADY RELEASED. No action taken.`);
                    return;
                }
                
                const officeSelect = document.getElementById('forwarderOffice');
                const options = Array.from(officeSelect.options).filter(opt => opt.value !== '').map(opt => opt.value);
                const officeList = options.join('\n- ');
                
                let newOffice = prompt(`Document ID ${docId} is currently **${doc.status.toUpperCase()}**.\n\n***RELEASE ACTION: Select New Destination***\n\nEnter the **EXACT** name of the New Destination Office:\n\nAvailable Offices:\n- ${officeList}`);

                if (newOffice) {
                    newOffice = newOffice.trim();
                    const validOffice = options.find(o => o.toUpperCase() === newOffice.toUpperCase());

                    if (validOffice) {
                        doc.dateReleased = getCurrentDateOnly();
                        doc.forwarderOffice = validOffice; 
                        doc.status = 'Released';
                        doc.loggedBy = getCurrentUser(); 
                        saveDocuments(); 
                        alert(`‚úÖ Document ID ${docId} has been **RELEASED** by ${getCurrentUser()} and forwarded to: ${validOffice}.`);
                    } else {
                        alert(`‚ùå Error: Invalid office name entered ("${newOffice}"). Please choose an existing office from the list.`);
                    }
                } else {
                    alert("Release action cancelled.");
                }

            } else if (action && action.toUpperCase() === 'DELETE') {
                const confirmDelete = confirm(`Are you sure you want to DELETE Document ID ${docId}? This action cannot be undone. Logged by: ${getCurrentUser()}`);
                if (confirmDelete) {
                    documents.splice(docIndex, 1);
                    saveDocuments(); 
                    alert(`üóëÔ∏è Document ID ${docId} has been DELETED by ${getCurrentUser()}.`);
                }
            } else {
                alert("Action cancelled or invalid option selected.");
            }

            displayDocuments();
            return;
        }

        if (docIndex === -1) {
            if (actionType === 'RELEASE') {
                alert(`‚ùå Error: Document ID ${docId} not found. A document must be logged (Accepted) before it can be Released.`);
                return;
            }
            
            if (actionType === 'ACCEPT') {
                logNewDocument(docId);
            }
        }
    }


    // --- Scanner Logic (Webcam) ---

    function startScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            stopScanner();
            return;
        }

        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }
        
        document.getElementById('scannerId').value = '';
        document.getElementById('scannerMessage').textContent = 'Starting camera... Please check your browser for permission request.';
        
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 100 },
            supportedScanFormats: [Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39] 
        };

        html5QrCode.start(
            { facingMode: "environment" }, 
            config,
            (decodedText, decodedResult) => {
                document.getElementById('scannerId').value = decodedText.toUpperCase();
                stopScanner();
                document.getElementById('scannerMessage').textContent = `‚úÖ Scanned ID: ${decodedText.toUpperCase()}. Click Accept or Release.`;
            },
            (errorMessage) => {})
        .catch((err) => {
            document.getElementById('scannerMessage').textContent = `‚ùå ERROR: Failed to start scanner. Check camera permission in your browser's address bar.`;
            console.error("Scanner startup error:", err);
            stopScanner();
        });

        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';
    }

    function stopScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
                document.getElementById('scannerMessage').textContent = 'Scanner stopped.';
                document.getElementById('startScanBtn').style.display = 'inline-block';
                document.getElementById('stopScanBtn').style.display = 'none';
            }).catch(err => {
                document.getElementById('scannerMessage').textContent = 'Scanner stopped (with error).';
            });
        } else {
             document.getElementById('scannerMessage').textContent = 'Scanner stopped.';
             document.getElementById('startScanBtn').style.display = 'inline-block';
             document.getElementById('stopScanBtn').style.display = 'none';
        }
    }


    // --- Table Rendering ---

    function displayDocuments() {
        const listBody = document.getElementById('documentList');
        listBody.innerHTML = '';
        
        documents.slice().reverse().forEach(doc => {
            const row = listBody.insertRow();
            
            row.insertCell().textContent = doc.id;
            
            const barcodeCell = row.insertCell();
            barcodeCell.className = 'barcode-cell';
            barcodeCell.innerHTML = generateBarcodeSVG(doc.id);

            row.insertCell().textContent = doc.type;
            row.insertCell().textContent = doc.sourceOffice;
            row.insertCell().textContent = doc.dateReceived;
            row.insertCell().textContent = doc.forwarderOffice; 
            row.insertCell().textContent = doc.dateReleased || 'Pending';
            
            const statusCell = row.insertCell();
            statusCell.textContent = doc.status;
            statusCell.style.fontWeight = 'bold';
            
            let statusColor = '#007bff'; 
            if (doc.status === 'Received') statusColor = '#28a745'; 
            if (doc.status === 'Released') statusColor = '#dc3545'; 
            
            statusCell.style.color = statusColor;
            
            row.insertCell().textContent = doc.loggedBy || 'N/A'; // Display Logged By

            // Render barcode after the cell is added to the DOM
            setTimeout(() => renderBarcode(doc.id), 0);
        });
        
        if (documents.length === 0) {
            listBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #777;">Start tracking your documents by clicking "Accept Document" after filling the form.</td></tr>';
        }
    }

    // --- Initialization: Load and Display Documents on page load ---
    document.addEventListener('DOMContentLoaded', () => {
        loadDocuments();
        console.log(`[Document Tracker] Loaded ${documents.length} documents from Local Storage.`);
        displayDocuments();
        checkLogin(); // Check for existing user session
    });
</script>

</body>
</html>
